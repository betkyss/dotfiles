#!/bin/bash
exec 2>/dev/null

BRIGHTNESS_STEP=10
MIN_BRIGHTNESS=10
MAX_BRIGHTNESS=100
STATE_FILE="/tmp/brightness_state"
NIGHT_FILE="/tmp/redshift_status"
FIFO="/tmp/polybar_light_fifo"

# Инициализация
init_state() {
    if [ ! -f "$STATE_FILE" ]; then
        if command -v light &>/dev/null; then
            light -G | awk '{printf "%d", $1}' > "$STATE_FILE"
        else
            echo "100" > "$STATE_FILE"
        fi
    fi
}

get_brightness() {
    init_state
    cat "$STATE_FILE"
}

save_brightness() {
    echo "$1" > "$STATE_FILE"
}

is_night_mode() {
    [ -f "$NIGHT_FILE" ]
}

# Уведомить polybar об обновлении
notify_update() {
    echo > "$FIFO"
}

# Применить всё атомарно
apply_all() {
    local brightness=$(get_brightness)
    local redshift_brightness=$(awk "BEGIN {printf \"%.2f\", $brightness / 100}")
    local temp=6500

    is_night_mode && temp=3500

    # Внешние мониторы: redshift управляет и температурой и яркостью
    redshift -P -O "$temp" -b "$redshift_brightness"

    # Встроенный монитор: настоящий backlight
    if command -v light &>/dev/null && light -L 2>/dev/null | grep -q backlight; then
        light -S "$brightness"
    fi
}

brightness_up() {
    local current=$(get_brightness)
    local new=$((current + BRIGHTNESS_STEP))
    ((new > MAX_BRIGHTNESS)) && new=$MAX_BRIGHTNESS
    save_brightness "$new"
    apply_all
    notify_update
}

brightness_down() {
    local current=$(get_brightness)
    local new=$((current - BRIGHTNESS_STEP))
    ((new < MIN_BRIGHTNESS)) && new=$MIN_BRIGHTNESS
    save_brightness "$new"
    apply_all
    notify_update
}

toggle_night_mode() {
    if is_night_mode; then
        rm "$NIGHT_FILE"
    else
        touch "$NIGHT_FILE"
    fi
    apply_all
    notify_update
}

print_status() {
    local brightness=$(get_brightness)
    if is_night_mode; then
        echo "${brightness}% "
    else
        echo "${brightness}% "
    fi
}

# Обработка аргументов
case "$1" in
    up)
        brightness_up
        exit 0
        ;;
    down)
        brightness_down
        exit 0
        ;;
    set)
        save_brightness "$2"
        apply_all
        notify_update
        exit 0
        ;;
    toggle)
        toggle_night_mode
        exit 0
        ;;
esac

# Режим tail - polybar запускает этот скрипт
init_state
[ -p "$FIFO" ] || mkfifo "$FIFO"
print_status

while read < "$FIFO"; do
    print_status
done
